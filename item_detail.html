<!doctype html>
<meta charset="utf-8">
<title>ì•„ì´í…œ ìƒì„¸</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --border:#e6e8ef;
    --text:#111827;
    --muted:#6b7280;
    --pill:#f3f4f6;
    --shadow:0 6px 20px rgba(17,24,39,.06);
  }
  *{box-sizing:border-box}
  body{margin:0; padding:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text);}
  .wrap{max-width:980px; margin:0 auto;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);; position:relative}
  .head{display:flex; gap:14px; align-items:flex-start; padding:16px;}
  .thumb{width:86px; height:86px; border-radius:14px; border:1px solid var(--border); background:#fff; object-fit:cover; flex:0 0 auto;}
  .hcol{flex:1 1 auto; min-width:240px;}
  .title{font-size:22px; font-weight:800; margin:0 0 2px;}
  .sub{font-size:13px; color:var(--muted); margin:0 0 10px;}
  .chips{display:flex; flex-wrap:wrap; gap:8px;}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--pill); border:1px solid var(--border); font-size:12px; color:#111827;}
  .chip b{font-weight:700}
  .section{padding:0 16px 16px;}
  .sec-title{display:flex; align-items:center; gap:8px; font-weight:800; margin:12px 0 10px;}
  .sec-title small{font-weight:600; color:var(--muted)}
  .box{border:1px solid var(--border); border-radius:14px; background:#fff; padding:12px;}
  .box-plain{border:0; background:transparent; padding:0;}

  .box-plain{border:0; background:transparent; padding:0;}
  .lang{display:grid; grid-template-columns:74px 1fr; gap:10px 12px; align-items:start;}
  .lang + .lang{margin-top:10px}
  .pill{display:inline-flex; align-items:center; justify-content:center; height:24px; padding:0 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fff; color:#111827; width:max-content;}
  .pill.ko{background:#fff1f2; border-color:#fecdd3;}
  .pill.zh{background:#fff7ed; border-color:#fed7aa;}
  .pill.ja{background:#eef2ff; border-color:#c7d2fe;}
  .pill.en{background:#ecfeff; border-color:#a5f3fc;}
  .text{white-space:pre-wrap; line-height:1.5; font-size:13.5px;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .imgcard{border:1px solid var(--border); border-radius:14px; background:#fff; overflow:hidden; min-height:180px; display:flex; align-items:center; justify-content:center;}
  .imgcard img{max-width:100%; height:auto; display:block;}
  /* Dye thumbnails (small like materials) */
  .dyegrid{display:flex; flex-wrap:wrap; gap:12px;}
  .dyeitem{width:62px; text-align:center;}
  .dyeitem img{width:56px; height:56px; border-radius:12px; object-fit:cover; display:block; border:1px solid var(--border); background:#fff;}

  .muted{color:var(--muted); font-size:13px;}
  .stats{display:flex; flex-wrap:wrap; gap:10px;}
  .stat{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#fff; font-size:13px;}
  .grade{width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:900; border:1px solid var(--border); background:var(--pill);}

  /* ===== ìŠ¤í™ ë“±ê¸‰ ìƒ‰ìƒ ===== */
  .grade.grade-SSS{background:linear-gradient(135deg,#c62828,#ff7043); color:#fff; border-color:rgba(198,40,40,.35); box-shadow:0 0 6px rgba(198,40,40,.35);}
  .grade.grade-SS{background:linear-gradient(135deg,#ad1457,#f06292); color:#fff; border-color:rgba(173,20,87,.28);}
  .grade.grade-S{background:linear-gradient(135deg,#f9a825,#ffd54f); color:#4a3500; border-color:rgba(249,168,37,.35);}
  .grade.grade-A{background:linear-gradient(135deg,#1565c0,#64b5f6); color:#fff; border-color:rgba(21,101,192,.25);}
  .grade.grade-C{background:linear-gradient(135deg,#616161,#bdbdbd); color:#222; border-color:rgba(97,97,97,.25);}

  .list{margin:0; padding-left:18px;}
  .materials{display:flex; flex-wrap:wrap; gap:12px;}
  .mat{width:62px; text-align:center;}
  .mat .mimg{width:56px; height:56px; border-radius:12px; border:1px solid var(--border); background:#fff; object-fit:cover;}
  .qty{margin-top:6px; font-size:12px; color:var(--muted);}
  .rowline{height:1px; background:var(--border); margin:0 16px;}

  .clickable{cursor:pointer}
  .matbtn{all:unset; cursor:pointer; width:62px; text-align:center;}
  .matbtn:focus{outline:2px solid rgba(59,130,246,.35); outline-offset:2px; border-radius:12px;}
  .matbtn:hover .mimg{transform:translateY(-1px); box-shadow:0 8px 18px rgba(17,24,39,.10);}
  .mimg{transition:transform .12s ease, box-shadow .12s ease;}
  .imgbtn{all:unset; cursor:pointer; display:block;}
  .imgbtn:hover img{transform:translateY(-1px); box-shadow:0 8px 18px rgba(17,24,39,.10);}
  .imgbtn img{transition:transform .12s ease, box-shadow .12s ease;}


  .controls{position:absolute; top:10px; right:10px; display:flex; gap:6px; z-index:5;}
  .ctrl-btn{width:32px; height:32px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer;
            display:flex; align-items:center; justify-content:center; font-size:18px; color:var(--muted); padding:0;}
  .ctrl-btn:hover{background:var(--pill); color:var(--text);}


  /* ===== íšë“ê²½ë¡œ ê°•ì¡° ===== */
  .source-box{
    border:1px solid var(--border);
    background:linear-gradient(180deg, #ffffff 0%, #fff7ed 100%);
    padding:12px;
    border-radius:14px;
    box-shadow: var(--shadow);
  }
  .source-list{list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; gap:8px;}
  .source-list li{
    padding:8px 10px;
    border-radius:999px;
    background:#ffffff;
    border:1px solid #ffd7aa;
    font-weight:700;
    color:#9a3412;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .source-list li::before{
    content:"ğŸ";
    font-size:14px;
  }

</style>

<div class="wrap">
  <div class="card">
  <div class="controls">
    <button class="ctrl-btn" id="btnBack" title="ë’¤ë¡œê°€ê¸°" aria-label="ë’¤ë¡œê°€ê¸°">â†</button>
    <button class="ctrl-btn" id="btnClose" title="ë‹«ê¸°" aria-label="ë‹«ê¸°">Ã—</button>
  </div>

    <div class="head">
      <img id="thumb" class="thumb" alt="" />
      <div class="hcol">
        <h1 class="title" id="title">ì•„ì´í…œ ìƒì„¸</h1>
        <p class="sub" id="subtitle">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
        <div class="chips" id="chips"></div>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="section">
      <div id="content" class="muted" style="padding:10px 2px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
  </div>
</div>

<script>

(function(){

  function closeDetailView(){
    try{
      const t = window.top;
      if (t && typeof t.closeDetail === "function") { t.closeDetail(); return; }
    }catch(e){}
    try{
      const p = window.parent;
      if (p && typeof p.closeDetail === "function") { p.closeDetail(); return; }
    }catch(e){}
    // fallback: hide self if embedded, else attempt window.close
    try{ window.close(); }catch(e){}
  }

  function bindHeaderButtons(){
    const back = document.getElementById("btnBack");
    const close = document.getElementById("btnClose");
    if (back) back.addEventListener("click", () => history.back());
    if (close) close.addEventListener("click", closeDetailView);
  }

  bindHeaderButtons();

  const qs = new URLSearchParams(location.search);
  const code = String(qs.get("code") || "");
  const part = String(qs.get("part") || "");

  const elTitle = document.getElementById("title");
  const elSub = document.getElementById("subtitle");
  const elChips = document.getElementById("chips");
  const elThumb = document.getElementById("thumb");
  const elContent = document.getElementById("content");

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

  function chip(html){ const d=document.createElement("div"); d.className="chip"; d.innerHTML=html; return d; }

  // --- Detail loader via postMessage (works even on file://) ---
  function loadDetail(){
    return new Promise((resolve) => {
      const frame = document.createElement("iframe");
      frame.style.display = "none";
      frame.src = "./item_details_frame.html";
      document.body.appendChild(frame);

      let done = false;
      const timeout = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        resolve({ok:false, error:"item_details_frame.htmlì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜, ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´."});
      }, 1800);

      function cleanup(){
        clearTimeout(timeout);
        window.removeEventListener("message", onMsg);
        try{ frame.remove(); }catch(e){}
      }

      function request(){
        try{
          frame.contentWindow.postMessage({type:"GET_ITEM_DETAIL", code}, "*");
        }catch(e){}
      }

      function onMsg(ev){
        const d = ev.data || {};
        if (d.type === "ITEM_DETAIL" && String(d.code) === code){
          if (done) return;
          done = true;
          cleanup();
          resolve({ok:true, detail:d.detail});
        }
        if (d.type === "ITEM_DETAILS_LOADED"){
          request();
        }
      }

      window.addEventListener("message", onMsg);
      frame.addEventListener("load", () => request());
    });
  }

  function pickThumb(detail){
    const imgs = detail && detail.imgs ? (Array.isArray(detail.imgs) ? detail.imgs : [detail.imgs]) : [];
    return imgs[0] || "";
  }

  function render(detail){
    // header
    const nm = (detail.names && (detail.names.ko || detail.names.en || detail.names.zh || detail.names.ja)) || "";
    elTitle.textContent = nm || "ì•„ì´í…œ ìƒì„¸";
    elSub.textContent = (detail.part || part || "") + " Â· ì½”ë“œ " + (detail.code ?? code);

    // thumb
    const th = pickThumb(detail);
    if (th){ elThumb.src = th; elThumb.style.visibility = "visible"; }
    else { elThumb.style.visibility = "hidden"; }

    // chips
    elChips.innerHTML = "";
    if (detail.heart) elChips.appendChild(chip("<b>â¤</b> " + esc(detail.heart)));
    if (detail.part || part) elChips.appendChild(chip("<b>ë¶€ìœ„</b> " + esc(detail.part || part)));
    elChips.appendChild(chip("<b>ì½”ë“œ</b> " + esc(detail.code ?? code)));

    const tags = Array.isArray(detail.tags) ? detail.tags.filter(Boolean) : [];
    for (const t of tags.slice(0, 12)){
      elChips.appendChild(chip(esc(t)));
    }

    // content sections
    const sections = [];

    // Names
    if (detail.names){
      const n = detail.names || {};
      sections.push(`
        <div class="sec-title">ì´ë¦„ <small>4ê°œ ì–¸ì–´</small></div>
        <div class="box">
          <div class="lang"><span class="pill ko">í•œêµ­</span><div class="text">${esc(n.ko||"")}</div></div>
          <div class="lang"><span class="pill en">ì˜ì–´</span><div class="text">${esc(n.en||"")}</div></div>
          <div class="lang"><span class="pill zh">ì¤‘êµ­</span><div class="text">${esc(n.zh||"")}</div></div>
          <div class="lang"><span class="pill ja">ì¼ë³¸</span><div class="text">${esc(n.ja||"")}</div></div>
        </div>
      `);
    }

    // Description
    if (detail.desc){
      const d = detail.desc || {};
      sections.push(`
        <div class="sec-title">ì•„ì´í…œ ì„¤ëª…</div>
        <div class="box">
          ${d.ko ? `<div class="lang"><span class="pill ko">í•œêµ­</span><div class="text">${esc(d.ko)}</div></div>` : ""}
          ${d.zh ? `<div class="lang"><span class="pill zh">ì¤‘êµ­</span><div class="text">${esc(d.zh)}</div></div>` : ""}
          ${d.ja ? `<div class="lang"><span class="pill ja">ì¼ë³¸</span><div class="text">${esc(d.ja)}</div></div>` : ""}
          ${d.en ? `<div class="lang"><span class="pill en">ì˜ì–´</span><div class="text">${esc(d.en)}</div></div>` : ""}
        </div>
      `);
    }

    // Images
    const imgs = detail.imgs ? (Array.isArray(detail.imgs) ? detail.imgs : [detail.imgs]) : [];
    if (imgs.length){
      const pairs = imgs.slice(0, 6);
      const cards = pairs.map(src => `<div class="imgcard"><img src="${esc(src)}" alt=""></div>`).join("");
      sections.push(`
        <div class="sec-title">ì´ë¯¸ì§€</div>
        <div class="grid2">${cards}</div>
      `);
    }

    // Stats
    const statCards = Array.isArray(detail.statCards) ? detail.statCards : [];
    if (statCards.length){
      const statsHtml = statCards.map(s=>{
        const name = esc(s.name || "");
        const grade = esc(s.grade || "");
        const txt = esc(s.text || "");
        const label = name ? name : (txt ? txt.split("/")[0].trim() : "");
        const g = grade || (txt.match(/\[([A-Z]{1,3})\]/)?.[1] || "");
        return `<div class="stat"><div class="grade grade-${g||""}">${g||"?"}</div><div>${esc(label||"ìŠ¤íƒ¯")}</div></div>`;
      }).join("");
      sections.push(`
        <div class="sec-title">ìŠ¤í™</div>
        <div class="stats">${statsHtml}</div>
      `);
    }

    // Sources
    const sources = detail.sources ? (Array.isArray(detail.sources) ? detail.sources : [detail.sources]) : [];
    if (sources.length){
      sections.push(`
        <div class="sec-title">íšë“ê²½ë¡œ</div>
        <div class="source-box">
          <ul class="source-list">${sources.map(s=>`<li>${esc(s)}</li>`).join("")}</ul>
        </div>
      `);
    }

    // Reform / materials (ë„ì•ˆ ì¬ë£Œ)
    if (detail.reform && detail.reform.enabled){
      const mats = Array.isArray(detail.reform.materials) ? detail.reform.materials : [];
      const matsHtml = mats.length ? mats.map(m=>{
        const img = esc(m.img || "");
        const qty = esc(m.qty || "");
        return `<div class="mat"><button class="matbtn" type="button" data-img="${img}"><img class="mimg" src="${img}" alt=""><div class="qty">Ã— ${qty}</div></button></div>`;
      }).join("") : `<div class="muted">ì¬ë£Œ ì •ë³´ê°€ ì—†ì–´.</div>`;
      sections.push(`
        <div class="sec-title">ë„ì•ˆ ì¬ë£Œ</div>
        <div class="box box-plain">
          <div class="materials">${matsHtml}</div>
        </div>
      `);
    }

    // Dye
    if (detail.dye && detail.dye.enabled){
      const dimgs = Array.isArray(detail.dye.images) ? detail.dye.images : [];
      const dpages = Array.isArray(detail.dye.pages) ? detail.dye.pages : [];
      const dHtml = dimgs.length ? dimgs.map((src, i)=>{
        const s = esc(src);
        const page = dpages[i] ? esc(dpages[i]) : "";
        const dataAttr = page ? ` data-page="${page}"` : ` data-img="${s}"`;
        return `<div class="dyeitem"><button class="imgbtn" type="button"${dataAttr}><img src="${s}" alt=""></button></div>`;
      }).join("") : `<div class="muted">ì—¼ìƒ‰ ì´ë¯¸ì§€ê°€ ì—†ì–´.</div>`;
      sections.push(`
        <div class="sec-title">ì—¼ìƒ‰</div>
        <div class="dyegrid">${dHtml}</div>
      `);
    }

    // fallback
    if (!sections.length){
      sections.push(`<div class="muted">í‘œì‹œí•  ìƒì„¸ ì •ë³´ê°€ ì—†ì–´.</div>`);
    }

    elContent.className = "";
    elContent.innerHTML = sections.join("");
  }

  
  function getParentItems(){
    try{
      // Walk up the frame tree to find the page that owns #itemsFrame
      let w = window;
      for (let i=0; i<8; i++){
        try{
          if (w && w.document){
            const fr = w.document.getElementById("itemsFrame");
            if (fr && fr.contentWindow && fr.contentWindow.ITEMS) return fr.contentWindow.ITEMS;
          }
        }catch(e){}
        if (!w || w === w.parent) break;
        w = w.parent;
      }

      // Also try opener chains (if opened as a popup)
      let o = window.opener;
      for (let i=0; i<4 && o; i++){
        try{
          if (o.document){
            const fr = o.document.getElementById("itemsFrame");
            if (fr && fr.contentWindow && fr.contentWindow.ITEMS) return fr.contentWindow.ITEMS;
          }
        }catch(e){}
        try{ if (o === o.parent) break; o = o.parent; }catch(e){ break; }
      }

      // Fallbacks (in case someone already mirrored ITEMS onto a parent)
      try{ if (window.ITEMS) return window.ITEMS; }catch(e){}
      try{ if (window.parent && window.parent.ITEMS) return window.parent.ITEMS; }catch(e){}
      try{ if (window.top && window.top.ITEMS) return window.top.ITEMS; }catch(e){}
      try{ if (window.opener && window.opener.ITEMS) return window.opener.ITEMS; }catch(e){}
      return null;
    }catch(e){
      return null;
    }
  }

  
  function requestTargetByImg(imgUrl){
    return new Promise((resolve) => {
      const reqId = "req_" + Math.random().toString(36).slice(2) + Date.now();
      let done = false;
      function cleanup(){
        window.removeEventListener('message', onMsg);
      }
      function onMsg(ev){
        const m = ev.data || {};
        if (m.type === 'FIND_ITEM_BY_IMG_RESPONSE' && m.reqId === reqId){
          done = true;
          cleanup();
          resolve(m.target || null);
        }
      }
      window.addEventListener('message', onMsg);
      // send to top; index.html will relay to itemsFrame
      try{ window.top.postMessage({ type:'FIND_ITEM_BY_IMG_REQUEST', reqId:reqId, img: imgUrl || "" }, '*'); }catch(e){}
      setTimeout(()=>{ if(done) return; cleanup(); resolve(null); }, 1200);
    });
  }
function parsePageToTarget(page){
    // expects like "1_í—¤ì–´-18.html" or "1_ì›í”¼ìŠ¤-598.html"
    const m = String(page||"").match(/^[^_]+_(.+)-(\d+)\.html$/);
    if (!m) return null;
    return { part: m[1], code: m[2] };
  }

  function gotoDetail(target){
    if (!target || !target.code) return;
    const params = new URLSearchParams(location.search);
    params.set("code", String(target.code));
    if (target.part) params.set("part", String(target.part));
    location.search = "?" + params.toString();
  }

  function driveId(url){
    const s = String(url||"");
    let m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    m = s.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    m = s.match(/thumbnail\?id=([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    return null;
  }

  function findByImg(img){
    const items = getParentItems();
    if (!items || !img) return null;

    const id = driveId(img);
    const norm = String(img).replace(/&sz=w\d+/g,"");

    for (const it of items){
      const cand = (it.thumb || it.img || it.image || "");
      if (!cand) continue;

      const cid = driveId(cand);
      if (id && cid && id === cid) return { code: it.code, part: it.part };

      const c = String(cand).replace(/&sz=w\d+/g,"");
      if (c === norm) return { code: it.code, part: it.part };
    }
    return null;
  }

  // Delegate clicks for materials/dye thumbnails
  elContent.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("button[data-page], button[data-img], [data-code]");
    if (!btn) return;
    const page = btn.getAttribute("data-page");
    if (page){
      const t = parsePageToTarget(page);
      if (t) return gotoDetail(t);
    }
    const codeAttr = btn.getAttribute("data-code");
    if (codeAttr){
      return gotoDetail({ code: codeAttr, part: btn.getAttribute("data-part") || "" });
    }
    const imgAttr = btn.getAttribute("data-img");
    if (imgAttr){
      // Try local match (may fail on file:// due to origin restrictions)
      const tLocal = findByImg(imgAttr);
      if (tLocal) return gotoDetail(tLocal);

      // Ask index(itemsFrame) via postMessage relay
      requestTargetByImg(imgAttr).then(t=>{
        if (t) return gotoDetail(t);
        // not found: keep focus only
      });
      return;
    }
  });

// start
  if (!code){
    elSub.textContent = "ì½”ë“œë¥¼ ë°›ì§€ ëª»í–ˆì–´.";
    elContent.textContent = "ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­í•˜ë©´ ì½”ë“œê°€ ì „ë‹¬ë¼.";
    return;
  }

  loadDetail().then(res=>{
    if (!res.ok || !res.detail){
      elSub.textContent = "ì½”ë“œ " + (code||"?") + " ìƒì„¸ë¥¼ ì°¾ì§€ ëª»í•¨";
      elContent.className = "muted";
      elContent.textContent = res.error || "ìƒì„¸ ë°ì´í„°ê°€ ì—†ì–´.";
      return;
    }
    render(res.detail);
  });
})();

</script>
