<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì„¸íŠ¸ì •ë³´</title>
<!-- sets_frame_fixed_v3 2026-02-06 -->
<style>
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,AppleSDGothicNeo,Segoe UI,Roboto,sans-serif;background:#f7f7fb;color:#222}
  .wrap{padding:12px}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .title{font-weight:800;font-size:16px}
  .muted{color:#777;font-size:12px}
  input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;min-width:220px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .card{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .thumb{width:100%;height:220px;object-fit:cover;background:#fafafa;display:block}
  .card .meta{padding:10px 10px 12px 10px;display:flex;flex-direction:column;gap:6px}
  .name{font-weight:800;font-size:14px;line-height:1.2}
  .sub{font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pillrow{display:flex;gap:6px;flex-wrap:wrap}
  .pill{font-size:11px;border:1px solid #eee;padding:3px 8px;border-radius:999px;background:#fafafa}
  .empty{padding:22px 6px;color:#666}
  .pager{display:flex;gap:6px;justify-content:center;align-items:center;flex-wrap:wrap;margin:14px 0 6px}
  .pbtn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
  .pbtn:hover{background:#fafafa}
  .pbtn[disabled]{opacity:.45;cursor:default}
  .pbtn[disabled]:hover{background:#fff}
  .pbtn.active{background:#2b115f;color:#fff;border-color:#2b115f}
  .pdots{color:#777;font-size:12px;padding:0 4px}
  dialog{border:0;padding:0;border-radius:18px;max-width:min(980px,96vw);width:980px;box-shadow:0 20px 70px rgba(0,0,0,.22);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);margin:0}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .dlg{display:flex;flex-direction:column;max-height:88vh;background:#fff;border-radius:18px;overflow:hidden}
  .dlgHead{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:14px 16px;border-bottom:1px solid #eee;background:#fff}
  .dlgTitle{display:flex;flex-direction:column;gap:4px}
  .dlgTitle .main{font-weight:900;font-size:18px}
  .dlgTitle .names{font-size:12px;color:#666;display:flex;flex-direction:column;gap:2px}
  .close{border:1px solid #eee;background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer}
  .close:hover{background:#fafafa}
  .dlgBody{padding:14px 16px;overflow:auto;background:#f7f7fb}
  .section{background:#fff;border:1px solid #eee;border-radius:16px;padding:12px;margin-bottom:12px}
  .section h3{margin:0 0 8px 0;font-size:14px}

  /* acquisition emphasis */
  .acqSection{border:2px solid #cdb7ff;background:linear-gradient(180deg,#fbf8ff 0%, #ffffff 60%);}
  .acqHead{display:flex;align-items:center;gap:10px;margin:0 0 10px 0}
  .acqBadge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:1000;letter-spacing:.2px;background:#6b3df0;color:#fff}
  .acqTitle{font-size:15px;font-weight:1000;color:#2b115f}

  /* ì´ë²¤íŠ¸ ì„¤ëª…/ê³µëµì€ ë‚´ë¶€ì— ë³„ë„ ê°•ì¡° ë°•ìŠ¤ê°€ ìˆìœ¼ë¯€ë¡œ, ë°”ê¹¥ ì»¨í…Œì´ë„ˆëŠ” "ë°•ìŠ¤"ê°€ ì•„ë‹Œ ì—¬ë°±ë§Œ */
  .eventPlain{margin-bottom:12px}
  .eventPlain h3{margin:0 0 10px 0;font-size:15px;font-weight:1000;color:#0f2042}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
  .gimg{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:12px;border:1px solid #eee;background:#fafafa;cursor:zoom-in}
  .sources{display:flex;flex-direction:column;gap:6px}
  .src{display:flex;gap:8px;align-items:flex-start}
  .src .k{min-width:110px;font-weight:700;font-size:12px;color:#333}
  .src .v{font-size:12px;color:#555;white-space:pre-wrap}
  .guide{margin-top:8px;padding-top:8px;border-top:1px dashed #eee;font-size:12px;color:#444;white-space:pre-wrap}
  .parts{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .pitem{display:flex;gap:10px;align-items:center;border:1px solid #eee;border-radius:14px;padding:10px;background:#fff;cursor:pointer}
  .pitem:hover{background:#fafcff}
  .pimg{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid #eee;background:#fafafa}
  .pmeta{display:flex;flex-direction:column;gap:2px;min-width:0}
  .pname{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .ppart{font-size:12px;color:#666}
  .code{font-size:11px;color:#777}

  /* emphasized event/guide boxes */
  .eventBox{border:2px solid #ffcc6a;background:#fff3d8;border-radius:16px;padding:12px 12px 12px 12px;margin-top:10px}
  .guideBox{border:2px solid #7bb6ff;background:#e9f3ff;border-radius:16px;padding:12px 12px 12px 12px;margin-top:10px}

  .hdr{display:flex;align-items:center;gap:10px;font-weight:900}
  .hdr .ico{font-size:18px}
  .hdr .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;letter-spacing:.2px}
  .hdr .tag-event{background:#ffb01a;color:#1a1200}
  .hdr .tag-guide{background:#1e7cff;color:#fff}
  .hdr .title{font-size:14px;font-weight:1000}

  .eventBox .body{margin-top:8px;font-size:13px;color:#2a1d00;white-space:pre-wrap;line-height:1.7}
  .guideBox .body{margin-top:8px;font-size:13px;color:#0f2042;white-space:pre-wrap;line-height:1.7}

  /* (eventPlainì—ì„œ ì²˜ë¦¬) */

  /* image zoom */
  .zoomDlg{max-width:min(980px,96vw);width:980px}
  .zoomBox{background:#000;border-radius:18px;overflow:hidden}
  .zoomImg{width:100%;height:auto;display:block}

  .setDesc{
    margin-top:10px;
    padding:12px 14px;
    border-radius:14px;
    background:#f3f4ff;
    border:1px solid #e3e6ff;
    font-size:13px;
    line-height:1.7;
    color:#2b2f55;
  }


  /* --- evolve variants --- */
  .evoStage{margin-top:14px}
  .evoHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 8px 0}
  .evoTitle{font-weight:1000;font-size:13px;color:#2b115f}
  .evoSub{font-weight:900;font-size:12px;color:#666;margin:8px 0}

  /* variants */
  .vgroup{margin-top:10px}
  .vtitle{font-weight:1000;font-size:13px;margin:0 0 8px 0;color:#2b115f}
  .vlist{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}

  /* evolve variants */
  .evoStage{margin-top:14px}
  .evoTitle{font-weight:1000;font-size:13px;color:#2b115f;margin:6px 0}
  .evoSub{font-weight:900;font-size:12px;color:#666;margin:8px 0}


  /* âœ… mobile: dialogs should appear immediately without needing to scroll */
  #itemDetailDialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);margin:0}

</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">ì„¸íŠ¸ ëª©ë¡</div>
    <input id="q" type="text" placeholder="ì„¸íŠ¸ ì´ë¦„ ê²€ìƒ‰ (í•œ/ì¤‘/ì˜/ë¶ë¯¸)"/>
    <div class="muted" id="status">ë¡œë”©ì¤‘...</div>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">ì„¸íŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´. (sets_data.htmlì— ì„¸íŠ¸ ì¶”ê°€í•´ì¤˜)</div>
  <div id="pager" class="pager" style="display:none"></div>
</div>

<dialog id="dlg">
  <div class="dlg">
    <div class="dlgHead">
      <div class="dlgTitle">
        <div class="main" id="dlgMain">-</div>
        <div class="names" id="dlgNames"></div>
      </div>
      <button class="close" id="closeBtn" type="button">ë‹«ê¸°</button>
    </div>
    <div class="dlgBody">
      <div class="section">
        <h3>ì„¸íŠ¸ì‚¬ì§„</h3>
        <div class="gallery" id="gallery"></div>
        <div id="setDesc" class="setDesc" style="display:none"></div>
      </div>

      <div class="section acqSection" id="acqSection">
        <div class="acqHead">
          <span class="acqBadge">ğŸ“ ì„¸íŠ¸ íšë“ê²½ë¡œ</span>
        </div>
        <div class="sources" id="sources"></div>
      </div>

      <!-- ì´ë²¤íŠ¸ ì˜ì—­ì€ ë‚´ë¶€ì— ì´ë¯¸ ê°•ì¡° ë°•ìŠ¤(eventBox/guideBox)ê°€ ìˆìœ¼ë‹ˆ, ë°”ê¹¥ ì„¹ì…˜ ë°•ìŠ¤ëŠ” ì œê±°í•´ì„œ ì¤‘ì²© ë°•ìŠ¤ ëŠë‚Œì„ ì—†ì•° -->
      <div id="eventSection" class="eventPlain" style="display:none">
        <div class="sources" id="eventInfo"></div>
      </div>

      <div class="section">
        <h3>ì„¸íŠ¸ ë¶€ìœ„ë³„ ì •ë³´</h3>
        <div class="muted" style="margin-bottom:8px">ë¶€ìœ„ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì˜ìƒ ìƒì„¸í˜ì´ì§€ê°€ ì—´ë ¤.</div>
        <div class="parts" id="parts"></div>
      </div>

      <div class="section" id="variantsSection" style="display:none">
        <h3>ë¦¬í¼ Â· ì§„í™” Â· í¬ì¦ˆ</h3>
        <div class="muted" style="margin-bottom:8px">íŒŒìƒ ì˜ìƒì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì•„ì´í…œ ìƒì„¸í˜ì´ì§€ê°€ ì—´ë ¤.</div>
        <div class="vlist" id="variants"></div>
      </div>

    </div>
  </div>
</dialog>

<dialog id="zoomDlg" class="zoomDlg">
  <div class="zoomBox">
    <img id="zoomImg" class="zoomImg" src="" alt="">
  </div>
</dialog>

<!-- Loaders (file:// safe) -->
<iframe id="setsLoader" src="sets_data.html" style="display:none"></iframe>
<iframe id="itemsLoader" src="items.html" style="display:none"></iframe>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const grid = $("grid");
  const empty = $("empty");
  const status = $("status");
  const q = $("q");
  const pager = $("pager");

  // pagination
  const PER_PAGE = 20;
  let currentPage = 1;

  // --- iframe auto-resize (monotonic: never report smaller height) ---
  let __ph_raf = 0;
  let __ph_max = 0;

  function __measureHeight(){
    return Math.max(
      document.body.scrollHeight || 0,
      document.documentElement.scrollHeight || 0
    );
  }

  function postHeightMonotonic(force=false){
    try{
      const h = Math.floor(__measureHeight());
      if(force) __ph_max = Math.max(__ph_max, h);
      else if(h > __ph_max) __ph_max = h;
      else return; // âœ… never send smaller height
      parent.postMessage({__iframeHeight: __ph_max, __frame:"sets"}, "*");
    }catch(e){}
  }

  function schedulePostHeight(force=false){
    if(__ph_raf) cancelAnimationFrame(__ph_raf);
    __ph_raf = requestAnimationFrame(()=>postHeightMonotonic(force));
  }


  const dlg = $("dlg");
  const dlgBody = dlg ? dlg.querySelector(".dlgBody") : null;
  const closeBtn = $("closeBtn");
  const dlgMain = $("dlgMain");
  const dlgNames = $("dlgNames");
  const gallery = $("gallery");
  const setDesc = $("setDesc");
  const sources = $("sources");
  const parts = $("parts");
  const variantsSection = $("variantsSection");
  const variants = $("variants");
  const eventSection = $("eventSection");
  const eventInfo = $("eventInfo");

  const zoomDlg = $("zoomDlg");
  const zoomImg = $("zoomImg");

  const setsLoaderEl = $("setsLoader");
  const itemsLoaderEl = $("itemsLoader");

  let SETS = [];
  let ITEMS = [];
  let BYKEY = Object.create(null);

  function norm(s){ return (s==null) ? "" : String(s); }
  function hasVariantType(set, type){
    const v = Array.isArray(set && set.variants) ? set.variants : [];
    const t = String(type||"").toLowerCase();
    return v.some(x => String((x && x.type)||"").toLowerCase() === t);
  }

function trim(s){ return norm(s).trim(); }

  function itemKey(part, code){
    return trim(part) + "||" + String(code);
  }

  function buildItemIndex(){
    const by = Object.create(null);
    for(const it of ITEMS){
      const part = trim(it.part);
      const code = it.code;
      if(!part || code==null) continue;
      by[itemKey(part, code)] = it;
    }
    BYKEY = by;
  }

  // âœ… ë¦¬ìŠ¤íŠ¸ í™”ë©´ì—ì„œëŠ” ì¤‘êµ­ì–´ë¥¼ ë³´ì—¬ì£¼ì§€ ì•ŠìŒ (ì˜ì–´/ì¼ë³¸ì–´ ìš°ì„ )
  function listMainName(set){
    return trim(set.name_en) || trim(set.name_jp) || trim(set.name_na) || trim(set.name_kr) || trim(set.name) || "ì´ë¦„ì—†ìŒ";
  }

  function listSubName(set){
    // ì„œë¸Œ ë¼ì¸ì€ ì¼ë³¸ì–´ë§Œ (ì—†ìœ¼ë©´ ë¹„ì›€)
    return trim(set.name_jp) || "";
  }

  // âœ… ìƒì„¸ íŒì—…ì—ì„œëŠ” ì¤‘êµ­ì–´ í¬í•¨ ì „ì²´ ì´ë¦„ í‘œì‹œ
  function displayName(set){
    return trim(set.name_kr) || trim(set.name_cn) || trim(set.name_en) || trim(set.name_na) || trim(set.name) || "ì´ë¦„ì—†ìŒ";
  }

  function allNames(set){
    const na = trim(set.name_na);
    const cn = trim(set.name_cn);
    const en = trim(set.name_en);
    let kr = trim(set.name_kr);

    // fallback: if KR missing, show "(ë²ˆì—­)" using CN -> EN -> NA
    if(!kr){
      const base = cn || en || na;
      if(base) kr = base + " (ë²ˆì—­)";
    }
    const lines = [];
    if(na) lines.push("ë¶ë¯¸: " + na);
    if(cn) lines.push("ì¤‘êµ­: " + cn);
    if(en) lines.push("ì˜ì–´: " + en);
    if(kr) lines.push("í•œêµ­: " + kr);
    return lines;
  }

  function matchesQuery(set, query){
    query = trim(query);
    if(!query) return true;

    const ql = query.toLowerCase();

    // sources í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
    const srcText = Array.isArray(set.sources)
      ? set.sources.map(s => [s.label, s.type, s.desc, s.text, s.value].map(x=>trim(x)).join(" ")).join(" ")
      : "";

    // event í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
    const ev = set.event || null;
    const evText = ev
      ? [ev.title, ev.desc, ev.guide].map(x=>trim(x)).join(" ")
      : "";

    const hay = [
      set.name_kr, set.name_cn, set.name_en, set.name_na, set.name_jp, set.name,
      set.id,
      srcText,
      evText
    ].map(x=>trim(x).toLowerCase()).join(" ");

    return hay.includes(ql);
  }

  function renderList(){
    const query = trim(q.value);
    const full = SETS.filter(s=>matchesQuery(s, query));
    const total = full.length;

    // empty + normalize page
    empty.style.display = (total===0) ? "block" : "none";

    const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    if(currentPage > totalPages) currentPage = totalPages;
    if(currentPage < 1) currentPage = 1;

    const start = (currentPage - 1) * PER_PAGE;
    const pageList = full.slice(start, start + PER_PAGE);

    grid.innerHTML = "";

    const frag = document.createDocumentFragment();
    for(const s of pageList){
      const card = document.createElement("div");
      card.className = "card";
      const img = trim(s.thumb) || (Array.isArray(s.images) && s.images[0]) || "";
      const sub = listSubName(s);
      card.innerHTML = `
        ${img ? `<img class="thumb" loading="lazy" decoding="async" src="${img}" alt="">` : `<div class="thumb"></div>`}
        <div class="meta">
          <div class="name">${escapeHtml(listMainName(s))}</div>
          ${sub ? `<div class="sub">${escapeHtml(sub)}</div>` : ``}
          <div class="pillrow">
            ${Array.isArray(s.parts) ? `<span class="pill">ë¶€ìœ„ ${s.parts.length}</span>` : ``}
            ${Array.isArray(s.images) ? `<span class="pill">ì‚¬ì§„ ${s.images.length}</span>` : ``}
          </div>
        </div>
      `;
      card.addEventListener("click", ()=>openSet(s));
      frag.appendChild(card);
    }
    grid.appendChild(frag);

    // pager
    renderPager(totalPages, total);

    const end = Math.min(total, start + PER_PAGE);
    const range = (total===0) ? "" : ` Â· ${start+1}-${end}`;
    const pageInfo = (totalPages>1) ? ` Â· ${currentPage}/${totalPages}` : "";
    status.textContent = `ì„¸íŠ¸ ${total} / ì „ì²´ ${SETS.length}${pageInfo}${range}`;

    schedulePostHeight(true);
  }

  function setPage(n){
    const next = Math.max(1, Math.min(n, Math.max(1, Math.ceil((SETS.filter(s=>matchesQuery(s, trim(q.value))).length) / PER_PAGE))));
    if(next === currentPage) return;
    currentPage = next;
    renderList();
    try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){ try{ window.scrollTo(0,0);}catch(_e){} }
  }

  function renderPager(totalPages, totalItems){
    if(!pager) return;
    if(totalItems<=0 || totalPages<=1){
      pager.style.display = "none";
      pager.innerHTML = "";
      return;
    }
    pager.style.display = "flex";
    pager.innerHTML = "";

    const makeBtn = (label, page, disabled=false, active=false)=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pbtn" + (active ? " active" : "");
      b.textContent = label;
      if(disabled) b.disabled = true;
      if(!disabled){
        b.addEventListener("click", ()=>setPage(page));
      }
      return b;
    };

    pager.appendChild(makeBtn("Â«", 1, currentPage===1));
    pager.appendChild(makeBtn("â€¹", currentPage-1, currentPage===1));

    // pages with ellipsis
    const pages = new Set([1, totalPages, currentPage, currentPage-1, currentPage+1, currentPage-2, currentPage+2]);
    const sorted = [...pages].filter(p=>p>=1 && p<=totalPages).sort((a,b)=>a-b);

    let prev = 0;
    for(const p of sorted){
      if(prev && p - prev > 1){
        const dots = document.createElement("span");
        dots.className = "pdots";
        dots.textContent = "â€¦";
        pager.appendChild(dots);
      }
      pager.appendChild(makeBtn(String(p), p, false, p===currentPage));
      prev = p;
    }

    pager.appendChild(makeBtn("â€º", currentPage+1, currentPage===totalPages));
    pager.appendChild(makeBtn("Â»", totalPages, currentPage===totalPages));
  }


  function openSet(set){
    if(!set) return;

    dlgMain.textContent = displayName(set);
    dlgNames.innerHTML = "";
    for(const line of allNames(set)){
      const div = document.createElement("div");
      div.textContent = line;
      dlgNames.appendChild(div);
    }

    // gallery
    gallery.innerHTML = "";
    const imgs = Array.isArray(set.images) ? set.images.slice(0, 10) : [];
    if(imgs.length){
      for(const u of imgs){
        const url = trim(u);
        if(!url) continue;
        const im = document.createElement("img");
        im.className = "gimg";
        im.src = url;
        im.loading = "lazy";
        im.decoding = "async";
        im.addEventListener("click", ()=>{
          zoomImg.src = url;
          if(zoomDlg && zoomDlg.showModal) zoomDlg.showModal();
        });
        gallery.appendChild(im);
      }
    }else{
      gallery.innerHTML = `<div class="muted">ì‚¬ì§„ ë°ì´í„°ê°€ ì—†ì–´.</div>`;
    }

    // âœ… ì„¸íŠ¸ ì„¤ëª… (í•œêµ­ì–´)
    const desc = trim(set.desc);
    if(desc){
      setDesc.textContent = desc;
      setDesc.style.display = "block";
    }else{
      setDesc.style.display = "none";
    }

    // sources
    sources.innerHTML = "";
    const srcs = Array.isArray(set.sources) ? set.sources : (set.source ? [set.source] : []);
    if(srcs.length){
      for(const s of srcs){
        const row = document.createElement("div");
        row.className = "src";
        const k = trim(s.label || s.type || "íšë“");
        const v = trim(s.text || s.desc || s.value || "");
        row.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v||"-")}</div>`;
        sources.appendChild(row);
        const guideText = trim(s.guide || s.tips || "");
        if(guideText){
          const g = document.createElement("div");
          g.className = "guide";
          g.textContent = guideText;
          sources.appendChild(g);
        }
      }
    }else{
      sources.innerHTML = `<div class="muted">íšë“ê²½ë¡œ ë°ì´í„°ê°€ ì—†ì–´.</div>`;
    }

    // event section (optional)
    const ev = set.event || null;
    if(ev && (trim(ev.desc)||trim(ev.guide)||trim(ev.title))){
      eventSection.style.display = "block";
      eventInfo.innerHTML = "";
      const title = trim(ev.title) || "ì´ë²¤íŠ¸";
      const desc = trim(ev.desc) || "-";
      const guide = trim(ev.guide) || "";

      // ğŸ‰ ì´ë²¤íŠ¸ ì„¤ëª… ë°•ìŠ¤
      const eBox = document.createElement("div");
      eBox.className = "eventBox";
      eBox.innerHTML = `
        <div class="hdr">
          <span class="ico">ğŸ‰</span>
          <span class="tag tag-event">ì´ë²¤íŠ¸ ì„¤ëª…</span>
          <span class="title">${escapeHtml(title)}</span>
        </div>
        <div class="body">${escapeHtml(desc)}</div>
      `;
      eventInfo.appendChild(eBox);

      // ğŸ§­ ê³µëµ ë°•ìŠ¤ (ìˆì„ ë•Œë§Œ)
      if(guide){
        const gBox = document.createElement("div");
        gBox.className = "guideBox";
        gBox.innerHTML = `
          <div class="hdr">
            <span class="ico">ğŸ§­</span>
            <span class="tag tag-guide">ê³µëµ</span>
            <span class="title">í•µì‹¬ í¬ì¸íŠ¸</span>
          </div>
          <div class="body">${escapeHtml(guide)}</div>
        `;
        eventInfo.appendChild(gBox);
      }
    }else{
      eventSection.style.display = "none";
      eventInfo.innerHTML = "";
    }

    // parts
    parts.innerHTML = "";
    const plist = Array.isArray(set.parts) ? set.parts : [];
    if(plist.length){
      const frag = document.createDocumentFragment();
      for(const p of plist){
        const part = trim(p.part);
        const code = (p.code==null) ? "" : p.code;
        const fromItems = BYKEY[itemKey(part, code)] || null;

        const img = trim(p.img) || trim(fromItems && fromItems.img) || "";
        const name = trim(p.name) || trim(fromItems && fromItems.name) || "-";

        const div = document.createElement("div");
        div.className = "pitem";
        div.innerHTML = `
          ${img ? `<img class="pimg" src="${img}" alt="">` : `<div class="pimg"></div>`}
          <div class="pmeta">
            <div class="pname">${escapeHtml(name)}</div>
            <div class="ppart">${escapeHtml(part || "-")}</div>
            <div class="code">code: ${escapeHtml(String(code||"-"))}</div>
          </div>
        `;
        div.addEventListener("click", ()=>openItemDetail({part, code}));
        frag.appendChild(div);
      }
      parts.appendChild(frag);
    }else{
      parts.innerHTML = `<div class="muted">ì„¸íŠ¸ ë¶€ìœ„ ë°ì´í„°ê°€ ì—†ì–´.</div>`;
    }

        // variants
    renderVariants(set);

    if(dlg && dlg.showModal) dlg.showModal();
  }




  
  function renderVariants(set){
    if(!variantsSection || !variants) return;

    variants.innerHTML = "";
    const vlist = Array.isArray(set && set.variants) ? set.variants : [];
    if(!vlist.length){
      variantsSection.style.display = "none";
      return;
    }
    variantsSection.style.display = "block";

    const frag = document.createDocumentFragment();

    for(const v of vlist){
      if(!v || typeof v !== "object") continue;
      const vtype = String(v.type||"").toLowerCase();

      const group = document.createElement("div");
      group.className = "vgroup";

      const vt = document.createElement("div");
      vt.className = "vtitle";
      vt.textContent = trim(v.label) || trim(v.type) || "íŒŒìƒ";
      group.appendChild(vt);

      // --- evolve: stages -> items + reform per stage
      if(vtype === "evolve" && Array.isArray(v.stages)){
        // âœ… "ë¦¬í¼ì²˜ëŸ¼" ë‹¨ê³„ë³„ë¡œ ì•„ë˜ë¡œ ìŒ“ê¸° (ìŠ¤í¬ë¡¤/ì§„í™”ê²°ê³¼/ì™„ë£Œ ë¬¸êµ¬ ì—†ìŒ)
        v.stages.forEach(stg=>{
          const stageGroup = document.createElement("div");
          stageGroup.className = "vgroup";

          const st = document.createElement("div");
          st.className = "vtitle";
          st.textContent = trim(stg.label) || (`ì§„í™” ${stg.stage || ""}ë‹¨ê³„`).trim();
          stageGroup.appendChild(st);

          const wrap = document.createElement("div");
          wrap.className = "vlist";

          const items = Array.isArray(stg.items) ? stg.items : [];
          items.forEach(it => wrap.appendChild(makeVariantCard(it)));

          const reforms = Array.isArray(stg.reform) ? stg.reform : [];
          reforms.forEach(it => wrap.appendChild(makeVariantCard(it)));

          stageGroup.appendChild(wrap);
          frag.appendChild(stageGroup);
        });

        continue;
      }

      // default: v.items list
      const wrap = document.createElement("div");
      wrap.className = "vlist";
      const items = Array.isArray(v.items) ? v.items : [];
      for(const it of items){
        wrap.appendChild(makeVariantCard(it));
      }
      group.appendChild(wrap);
      frag.appendChild(group);
    }

    variants.appendChild(frag);
  }

  function makeVariantCard(it){
    const part = trim(it.part);
    const code = (it.code==null) ? "" : it.code;
    if(!part || code==="") return document.createElement("span");

    const fromItems = BYKEY[itemKey(part, code)] || null;
    const img = trim(it.img) || trim(fromItems && fromItems.img) || "";
    const name = trim(it.name) || trim(fromItems && fromItems.name) || "-";

    const base = (it.base_code!=null && it.base_code!=="") ? ` / base:${it.base_code}` : "";
    const chain = (it.chain_from!=null && it.chain_from!=="") ? ` / from:${it.chain_from}` : "";
    const color = trim(it.color) ? ` / ${trim(it.color)}` : "";

    const div = document.createElement("div");
    div.className = "pitem";
    div.innerHTML = `
      ${img ? `<img class="pimg" src="${img}" alt="">` : `<div class="pimg"></div>`}
      <div class="pmeta">
        <div class="pname">${escapeHtml(name)}</div>
        <div class="ppart">${escapeHtml(part || "-")}</div>
        <div class="code">code: ${escapeHtml(String(code||"-"))}${escapeHtml(color)}${escapeHtml(base)}${escapeHtml(chain)}</div>
      </div>
    `;
    div.addEventListener("click", ()=>openItemDetail({part, code}));
    return div;
  }

  function openItemDetail(ref){
    const part = trim(ref && (ref.part || ref.category || ''));
    const code = ref && (ref.code ?? ref.itemCode ?? ref.id);
    if(!part || code==null || code==="") return;

    const url = `item_detail.html?code=${encodeURIComponent(String(code))}&part=${encodeURIComponent(String(part))}`;

    const dlg2 = document.getElementById('itemDetailDialog');
    const frame2 = document.getElementById('itemDetailFrame');
    if(dlg2 && frame2){
      frame2.src = url;
      if (typeof dlg2.showModal === 'function') dlg2.showModal();
      else dlg2.setAttribute('open','open');
      return;
    }

    // fallback
    window.open(url, "_blank");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  closeBtn.addEventListener("click", ()=>{ try{ dlg.close(); }catch(e){} });

  // âœ… ë¹ˆ í™”ë©´(ë‹¤ì´ì–¼ë¡œê·¸ ë°”ê¹¥ ì˜ì—­) í´ë¦­ ì‹œ ë‹«ê¸°
  // dialogëŠ” backdrop ìì²´ì— ì´ë²¤íŠ¸ê°€ ì•ˆ ì¡íˆë¯€ë¡œ,
  // dialog ìš”ì†Œ ìì²´ë¥¼ í´ë¦­í–ˆì„ ë•Œ(targetì´ dialogì¼ ë•Œ) ë‹«ë„ë¡ ì²˜ë¦¬
  if(dlg){
    dlg.addEventListener("click", (e)=>{
      if(e.target === dlg){
        try{ dlg.close(); }catch(err){}
      }
    });
    // ESCëŠ” ê¸°ë³¸ cancel ì´ë²¤íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ”ë°, ê¸°ë³¸ ë™ì‘ ìœ ì§€(ë‹«í˜) + í˜¹ì‹œ ë§‰í˜€ìˆì„ ë•Œ ëŒ€ë¹„
    dlg.addEventListener("cancel", ()=>{ try{ dlg.close(); }catch(err){} });
  }

  if(dlg){
    dlg.addEventListener("close", ()=>{ /* noop */ });
    dlg.addEventListener("cancel", ()=>{ /* noop */ });
  }
  if(zoomDlg){
    zoomDlg.addEventListener("click", ()=>{ try{ zoomDlg.close(); }catch(e){} });
    zoomDlg.addEventListener("cancel", ()=>{ try{ zoomDlg.close(); }catch(e){} });
  }

  q.addEventListener("input", ()=>{ currentPage = 1; renderList(); });

  // receive data from iframes
  window.addEventListener("message", (ev)=>{
    const msg = ev && ev.data;
    if(!msg || typeof msg !== "object") return;

    if(msg.__splitData === true && msg.key === "sets" && Array.isArray(msg.data)){
      SETS = msg.data.filter(x=>x && typeof x === "object");
      status.textContent = SETS.length ? ("ì„¸íŠ¸ ë¡œë“œ ì™„ë£Œ: " + SETS.length + "ê°œ") : "ì„¸íŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´.";
      renderList();
  schedulePostHeight(true);
      return;
    }

    if(msg.__splitData === true && msg.key === "items" && Array.isArray(msg.data)){
      ITEMS = msg.data.filter(x=>x && typeof x === "object");
      buildItemIndex();
      // keep status if sets already loaded
      renderList();
      return;
    }
  });


  // âœ… fallback: file:// í™˜ê²½ì—ì„œ sets_data.html / items.html ì´ postMessageë¥¼ ì•ˆ ë³´ë‚´ëŠ” ê²½ìš°,
  // iframe ì•ˆì˜ window.SETS / window.ITEMS ë¥¼ ì§ì ‘ ì½ì–´ì„œ ë¡œë”©
  function tryReadFromIframes(){
    // sets
    try{
      if(Array.isArray(SETS) && SETS.length){} else{
        const data = setsLoaderEl && setsLoaderEl.contentWindow && setsLoaderEl.contentWindow.SETS;
        if(Array.isArray(data)){
          SETS = data.filter(x=>x && typeof x === "object");
          status.textContent = SETS.length ? ("ì„¸íŠ¸ ë¡œë“œ ì™„ë£Œ: " + SETS.length + "ê°œ") : "ì„¸íŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´.";
          renderList();
          schedulePostHeight(true);
        }
      }
    }catch(e){}
    // items
    try{
      if(Array.isArray(ITEMS) && ITEMS.length){} else{
        const data2 = itemsLoaderEl && itemsLoaderEl.contentWindow && (itemsLoaderEl.contentWindow.ITEMS || itemsLoaderEl.contentWindow.items || itemsLoaderEl.contentWindow.window && itemsLoaderEl.contentWindow.window.ITEMS);
        if(Array.isArray(data2)){
          ITEMS = data2.filter(x=>x && typeof x === "object");
          buildItemIndex();
          renderList();
        }
      }
    }catch(e){}
  }

  if(setsLoaderEl){
    setsLoaderEl.addEventListener("load", ()=>{ tryReadFromIframes(); });
  }
  if(itemsLoaderEl){
    itemsLoaderEl.addEventListener("load", ()=>{ tryReadFromIframes(); });
  }


    // initial render
  renderList();
})();

  function hookImages(){
    document.querySelectorAll("img").forEach(img=>{
      if(img.__ph_hooked) return;
      img.__ph_hooked = true;
      img.addEventListener("load", ()=>schedulePostHeight(true));
      img.addEventListener("error", ()=>schedulePostHeight(true));
    });
  }
  window.addEventListener("load", ()=>{ hookImages(); schedulePostHeight(true); });
  window.addEventListener("resize", ()=>schedulePostHeight(true));

</script>

<!-- âœ… Item detail tab (dialog) -->
<dialog id="itemDetailDialog" style="width:min(980px,92vw);height:min(86vh,900px);padding:0;border:0;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.25);">
  
<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eee;">
  <div style="font-weight:700;">ì•„ì´í…œ ìƒì„¸</div>
  <div style="display:flex;gap:6px;align-items:center;">
    <button type="button" id="itemDetailBackBtn" title="ë’¤ë¡œê°€ê¸°"
      style="border:0;background:transparent;font-size:18px;line-height:1;cursor:pointer;padding:4px 8px;border-radius:6px;">â†</button>
    <button type="button" id="itemDetailCloseBtn" title="ë‹«ê¸°"
      style="border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;padding:2px 8px;border-radius:6px;">Ã—</button>
  </div>
</div>

  <iframe id="itemDetailFrame" style="width:100%;height:calc(86vh - 46px);border:0;display:block;" loading="eager"></iframe>
</dialog>
<script>
  (function(){
    const dlg = document.getElementById('itemDetailDialog');
    const btn = document.getElementById('itemDetailCloseBtn');
    if(btn && dlg) btn.addEventListener('click', ()=>{ try{ dlg.close(); }catch(e){ dlg.removeAttribute('open'); }});
    if(dlg) dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); try{ dlg.close(); }catch(err){} });
  })();
</script>

</body>
</html>
